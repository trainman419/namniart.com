<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type" />
  <title>Lake Denman - Copying files between S3 buckets</title>
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  <!-- Homepage CSS -->
  <link rel="stylesheet" href="/css/style-nik.css" type="text/css" media="screen, projection" />
</head>

<body id="post">
  <div id='content-wrapper'>
    <h1 id='page-title'>
      <a href="/">
        Lake Denman
      </a>
    </h1>

    <div id='content'>
      <h2>Copying files between S3 buckets</h2>
      <p>The solution that I came up with for copying content from one S3 bucket to another was fairly easy to implement. My solution heavily relies on a fantastic ruby library called <a href='http://rightscale.rubyforge.org/right_aws_gem_doc/'>RightAws</a>.</p>
<div class='highlight'><pre><code class='ruby'><span class='nb'>require</span> <span class='s1'>&#39;rubygems&#39;</span>
<span class='nb'>require</span> <span class='s1'>&#39;right_aws&#39;</span>

<span class='n'>aws_access_key_id</span> <span class='o'>=</span> <span class='s1'>&#39;PUT YOUR ACCESS KEY ID FROM AMAZON HERE&#39;</span>
<span class='n'>aws_secret_access_key</span> <span class='o'>=</span> <span class='s1'>&#39;PUT YOUR SECRET ACCESS KEY FROM AMAZON HERE&#39;</span>
<span class='n'>target_bucket</span> <span class='o'>=</span> <span class='s1'>&#39;BUCKET_COPYING_FROM&#39;</span>
<span class='n'>destination_bucket</span> <span class='o'>=</span> <span class='s1'>&#39;BUCKET_COPYING_TO&#39;</span>

<span class='n'>s3</span> <span class='o'>=</span> <span class='no'>RightAws</span><span class='o'>::</span><span class='no'>S3Interface</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='n'>aws_access_key_id</span><span class='p'>,</span> <span class='n'>aws_secret_access_key</span><span class='p'>)</span>

<span class='n'>copied_keys</span> <span class='o'>=</span> <span class='nb'>Array</span><span class='o'>.</span><span class='n'>new</span>
<span class='n'>s3</span><span class='o'>.</span><span class='n'>incrementally_list_bucket</span><span class='p'>(</span><span class='n'>destination_bucket</span><span class='p'>)</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>key_set</span><span class='o'>|</span> 
  <span class='n'>copied_keys</span> <span class='o'>&lt;&lt;</span> <span class='n'>key_set</span><span class='o'>[</span><span class='ss'>:contents</span><span class='o'>].</span><span class='n'>map</span><span class='p'>{</span><span class='o'>|</span><span class='n'>k</span><span class='o'>|</span> <span class='n'>k</span><span class='o'>[</span><span class='ss'>:key</span><span class='o'>]</span><span class='p'>}</span><span class='o'>.</span><span class='n'>flatten</span> 
<span class='k'>end</span>
<span class='n'>copied_keys</span><span class='o'>.</span><span class='n'>flatten!</span>

<span class='n'>s3</span><span class='o'>.</span><span class='n'>incrementally_list_bucket</span><span class='p'>(</span><span class='n'>target_bucket</span><span class='p'>)</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>key_set</span><span class='o'>|</span>
  <span class='n'>key_set</span><span class='o'>[</span><span class='ss'>:contents</span><span class='o'>].</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>key</span><span class='o'>|</span>
    <span class='n'>key</span> <span class='o'>=</span> <span class='n'>key</span><span class='o'>[</span><span class='ss'>:key</span><span class='o'>]</span>
    <span class='k'>if</span> <span class='n'>copied_keys</span><span class='o'>.</span><span class='n'>include?</span><span class='p'>(</span><span class='n'>key</span><span class='p'>)</span>
      <span class='nb'>puts</span> <span class='s2'>&quot;</span><span class='si'>#{</span><span class='n'>destination_bucket</span><span class='si'>}</span><span class='s2'> </span><span class='si'>#{</span><span class='n'>key</span><span class='si'>}</span><span class='s2'> already exists. Skipping...&quot;</span>
    <span class='k'>else</span>
      <span class='nb'>puts</span> <span class='s2'>&quot;Copying </span><span class='si'>#{</span><span class='n'>target_bucket</span><span class='si'>}</span><span class='s2'> </span><span class='si'>#{</span><span class='n'>key</span><span class='si'>}</span><span class='s2'>&quot;</span>

      <span class='n'>retries</span><span class='o'>=</span><span class='mi'>0</span>
      <span class='k'>begin</span>
        <span class='n'>s3</span><span class='o'>.</span><span class='n'>copy</span><span class='p'>(</span><span class='n'>target_bucket</span><span class='p'>,</span> <span class='n'>key</span><span class='p'>,</span> <span class='n'>destination_bucket</span><span class='p'>)</span>
      <span class='k'>rescue</span> <span class='no'>Exception</span> <span class='o'>=&gt;</span> <span class='n'>e</span>
        <span class='nb'>puts</span> <span class='s2'>&quot;cannot copy key, </span><span class='si'>#{</span><span class='n'>e</span><span class='o'>.</span><span class='n'>inspect</span><span class='si'>}</span><span class='se'>\n</span><span class='s2'>retrying </span><span class='si'>#{</span><span class='n'>retries</span><span class='si'>}</span><span class='s2'> out of 10 times...&quot;</span>
        <span class='n'>retries</span> <span class='o'>+=</span> <span class='mi'>1</span>
        <span class='k'>retry</span> <span class='k'>if</span> <span class='n'>retries</span> <span class='o'>&lt;=</span> <span class='mi'>10</span>
      <span class='k'>end</span>
    <span class='k'>end</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>If you have access to an EC2 instance, which should be pretty easy to get, you can run the above script on it and you won&#8217;t be charged for bandwidth. It is recommended that you take that approach.</p>

<p>This code was somewhat inspired by <a href='http://www.elctech.com'>ELCtech.com&#8217;s</a> post entitled <a href='http://www.elctech.com/tutorials/copying-files-between-s3-accounts'>&#8220;Copying files between S3 accounts&#8221;</a>. Just to be clear, ELCtech&#8217;s solution is for copying bucket contents between multiple S3 accounts. The solution posted here is for copying bucket contents between one S3 account.</p>
      <a class="home" href="/">Home</a>
    </div>

    <div id= 'footer'>
      <a href="mailto:lake@lakedenman.com">Email</a> | 
      <a href="skype:call?name=lakedenman">Skype</a> | 
      <a href="http://twitter.com/ldenman">Twitter</a> |
      <a href="http://github.com/ldenman">Github</a>
    </div>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-350849-5");
      pageTracker._trackPageview();
      } catch(err) {}
      </script>
    </div>
  </body>
</html>