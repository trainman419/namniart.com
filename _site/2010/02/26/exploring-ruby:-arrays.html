<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type" />
  <title>Lake Denman - Exploring Ruby: Arrays - the zip method</title>
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  <!-- Homepage CSS -->
  <link rel="stylesheet" href="/css/style-nik.css" type="text/css" media="screen, projection" />
</head>

<body id="post">
  <div id='content-wrapper'>
    <h1 id='page-title'>
      <a href="/">
        Lake Denman
      </a>
    </h1>

    <div id='content'>
      <h2>Exploring Ruby: Arrays - the zip method</h2>
      <p>Here is an exploration for an instance method named &#8220;zip&#8221;. The following is what we find.</p>

<p>We begin by opening the ruby source. Naturally, we&#8217;ll find the zip method in the array.c file. The method that we are looking for is:</p>

<p><em>rb_ary_zip</em></p>

<p>At this point, we can read the documentation and see what this method actually does:</p>
<div class='highlight'><pre><code class='text'>  /*
   *  call-seq:
   *     array.zip(arg, ...)                   -&gt; an_array
   *     array.zip(arg, ...) {| arr | block }  -&gt; nil
   *
   *  Converts any arguments to arrays, then merges elements of
   *  &lt;i&gt;self&lt;/i&gt; with corresponding elements from each argument. This
   *  generates a sequence of &lt;code&gt;self.size&lt;/code&gt; &lt;em&gt;n&lt;/em&gt;-element
   *  arrays, where &lt;em&gt;n&lt;/em&gt; is one more that the count of arguments. If
   *  the size of any argument is less than &lt;code&gt;enumObj.size&lt;/code&gt;,
   *  &lt;code&gt;nil&lt;/code&gt; values are supplied. If a block given, it is
   *  invoked for each output array, otherwise an array of arrays is
   *  returned.
   *
   *     a = [ 4, 5, 6 ]
   *     b = [ 7, 8, 9 ]
   *     [1,2,3].zip(a, b)      #=&gt; [[1, 4, 7], [2, 5, 8], [3, 6, 9]]
   *     [1,2].zip(a,b)         #=&gt; [[1, 4, 7], [2, 5, 8]]
   *     a.zip([1,2],[8])       #=&gt; [[4,1,8], [5,2,nil], [6,nil,nil]]
   */
</code></pre>
</div>
<p>At first glance, that sounds heavy. Let&#8217;s try to break it down&#8230;</p>

<p>Scratch that! Heard of rubinius? Let&#8217;s check that out and see what sort of specs are written for the zip method.</p>

<p>Real quick, rubinius is a ruby virtual machine implemented in ruby. It comes with specs, so we can look at those.</p>

<p>These are the #zip method specs found in</p>

<p><em>zip_spec.rb</em></p>
<div class='highlight'><pre><code class='ruby'>  
<span class='n'>describe</span> <span class='s2'>&quot;Array#zip&quot;</span> <span class='k'>do</span>
  <span class='n'>it</span> <span class='s2'>&quot;returns an array of arrays containing corresponding elements of each array&quot;</span> <span class='k'>do</span>
    <span class='o'>[</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>,</span> <span class='mi'>4</span><span class='o'>].</span><span class='n'>zip</span><span class='p'>(</span><span class='o'>[</span><span class='s2'>&quot;a&quot;</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='p'>,</span> <span class='s2'>&quot;c&quot;</span><span class='p'>,</span> <span class='s2'>&quot;d&quot;</span><span class='p'>,</span> <span class='s2'>&quot;e&quot;</span><span class='o'>]</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span>
      <span class='o'>[[</span><span class='mi'>1</span><span class='p'>,</span> <span class='s2'>&quot;a&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>2</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>3</span><span class='p'>,</span> <span class='s2'>&quot;c&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>4</span><span class='p'>,</span> <span class='s2'>&quot;d&quot;</span><span class='o'>]]</span>
  <span class='k'>end</span>

  <span class='n'>it</span> <span class='s2'>&quot;fills in missing values with nil&quot;</span> <span class='k'>do</span>
    <span class='o'>[</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>5</span><span class='o'>].</span><span class='n'>zip</span><span class='p'>(</span><span class='o'>[</span><span class='s2'>&quot;a&quot;</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='p'>,</span> <span class='s2'>&quot;c&quot;</span><span class='p'>,</span> <span class='s2'>&quot;d&quot;</span><span class='o'>]</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span>
      <span class='o'>[[</span><span class='mi'>1</span><span class='p'>,</span> <span class='s2'>&quot;a&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>2</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>3</span><span class='p'>,</span> <span class='s2'>&quot;c&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>4</span><span class='p'>,</span> <span class='s2'>&quot;d&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>5</span><span class='p'>,</span> <span class='kp'>nil</span><span class='o'>]]</span>
  <span class='k'>end</span>

  <span class='n'>it</span> <span class='s2'>&quot;properly handles recursive arrays&quot;</span> <span class='k'>do</span>
    <span class='n'>a</span> <span class='o'>=</span> <span class='o'>[]</span><span class='p'>;</span> <span class='n'>a</span> <span class='o'>&lt;&lt;</span> <span class='n'>a</span>
    <span class='n'>b</span> <span class='o'>=</span> <span class='o'>[</span><span class='mi'>1</span><span class='o'>]</span><span class='p'>;</span> <span class='n'>b</span> <span class='o'>&lt;&lt;</span> <span class='n'>b</span>

    <span class='n'>a</span><span class='o'>.</span><span class='n'>zip</span><span class='p'>(</span><span class='n'>a</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='o'>[</span> <span class='o'>[</span><span class='n'>a</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>a</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]]</span> <span class='o'>]</span>
    <span class='n'>a</span><span class='o'>.</span><span class='n'>zip</span><span class='p'>(</span><span class='n'>b</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='o'>[</span> <span class='o'>[</span><span class='n'>a</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>b</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]]</span> <span class='o'>]</span>
    <span class='n'>b</span><span class='o'>.</span><span class='n'>zip</span><span class='p'>(</span><span class='n'>a</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='o'>[</span> <span class='o'>[</span><span class='n'>b</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>a</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]]</span><span class='p'>,</span> <span class='o'>[</span><span class='n'>b</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>a</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>]]</span> <span class='o'>]</span>
    <span class='n'>b</span><span class='o'>.</span><span class='n'>zip</span><span class='p'>(</span><span class='n'>b</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='o'>[</span> <span class='o'>[</span><span class='n'>b</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>b</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]]</span><span class='p'>,</span> <span class='o'>[</span><span class='n'>b</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>b</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>]]</span> <span class='o'>]</span>
  <span class='k'>end</span>

  <span class='n'>it</span> <span class='s2'>&quot;calls #to_ary to convert the argument to an Array&quot;</span> <span class='k'>do</span>
    <span class='n'>obj</span> <span class='o'>=</span> <span class='n'>mock</span><span class='p'>(</span><span class='s1'>&#39;[3,4]&#39;</span><span class='p'>)</span>
    <span class='n'>obj</span><span class='o'>.</span><span class='n'>should_receive</span><span class='p'>(</span><span class='ss'>:to_ary</span><span class='p'>)</span><span class='o'>.</span><span class='n'>and_return</span><span class='p'>(</span><span class='o'>[</span><span class='mi'>3</span><span class='p'>,</span> <span class='mi'>4</span><span class='o'>]</span><span class='p'>)</span>
    <span class='o'>[</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='o'>].</span><span class='n'>zip</span><span class='p'>(</span><span class='n'>obj</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='o'>[[</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>3</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>2</span><span class='p'>,</span> <span class='mi'>4</span><span class='o'>]]</span>
  <span class='k'>end</span>

  <span class='n'>it</span> <span class='s2'>&quot;calls block if supplied&quot;</span> <span class='k'>do</span>
    <span class='n'>values</span> <span class='o'>=</span> <span class='o'>[]</span>
    <span class='o'>[</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>,</span> <span class='mi'>4</span><span class='o'>].</span><span class='n'>zip</span><span class='p'>(</span><span class='o'>[</span><span class='s2'>&quot;a&quot;</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='p'>,</span> <span class='s2'>&quot;c&quot;</span><span class='p'>,</span> <span class='s2'>&quot;d&quot;</span><span class='p'>,</span> <span class='s2'>&quot;e&quot;</span><span class='o'>]</span><span class='p'>)</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>value</span><span class='o'>|</span>
      <span class='n'>values</span> <span class='o'>&lt;&lt;</span> <span class='n'>value</span>
    <span class='p'>}</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='kp'>nil</span>

    <span class='n'>values</span><span class='o'>.</span><span class='n'>should</span> <span class='o'>==</span> <span class='o'>[[</span><span class='mi'>1</span><span class='p'>,</span> <span class='s2'>&quot;a&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>2</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>3</span><span class='p'>,</span> <span class='s2'>&quot;c&quot;</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span><span class='mi'>4</span><span class='p'>,</span> <span class='s2'>&quot;d&quot;</span><span class='o'>]]</span>
  <span class='k'>end</span>

  <span class='n'>it</span> <span class='s2'>&quot;does not return subclass instance on Array subclasses&quot;</span> <span class='k'>do</span>
    <span class='no'>ArraySpecs</span><span class='o'>::</span><span class='no'>MyArray</span><span class='o'>[</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='o'>].</span><span class='n'>zip</span><span class='p'>(</span><span class='o'>[</span><span class='s2'>&quot;a&quot;</span><span class='p'>,</span> <span class='s2'>&quot;b&quot;</span><span class='o'>]</span><span class='p'>)</span><span class='o'>.</span><span class='n'>should</span> <span class='n'>be_kind_of</span><span class='p'>(</span><span class='nb'>Array</span><span class='p'>)</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Thanks to Brian Ford for the specs that he wrote.</p>

<p>It may be interesting to look at the c implementation and the rubinius implementation.</p>

<p><em>C Implementation</em></p>
<div class='highlight'><pre><code class='c'><span class='k'>static</span> <span class='n'>VALUE</span>
<span class='nf'>rb_ary_zip</span><span class='p'>(</span><span class='kt'>int</span> <span class='n'>argc</span><span class='p'>,</span> <span class='n'>VALUE</span> <span class='o'>*</span><span class='n'>argv</span><span class='p'>,</span> <span class='n'>VALUE</span> <span class='n'>ary</span><span class='p'>)</span>
<span class='p'>{</span>
    <span class='kt'>int</span> <span class='n'>i</span><span class='p'>,</span> <span class='n'>j</span><span class='p'>;</span>
    <span class='kt'>long</span> <span class='n'>len</span><span class='p'>;</span>
    <span class='n'>VALUE</span> <span class='n'>result</span> <span class='o'>=</span> <span class='n'>Qnil</span><span class='p'>;</span>

    <span class='n'>len</span> <span class='o'>=</span> <span class='n'>RARRAY_LEN</span><span class='p'>(</span><span class='n'>ary</span><span class='p'>);</span>
    <span class='k'>for</span> <span class='p'>(</span><span class='n'>i</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='n'>i</span><span class='o'>&lt;</span><span class='n'>argc</span><span class='p'>;</span> <span class='n'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
	<span class='n'>argv</span><span class='p'>[</span><span class='n'>i</span><span class='p'>]</span> <span class='o'>=</span> <span class='n'>take_items</span><span class='p'>(</span><span class='n'>argv</span><span class='p'>[</span><span class='n'>i</span><span class='p'>],</span> <span class='n'>len</span><span class='p'>);</span>
    <span class='p'>}</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='n'>rb_block_given_p</span><span class='p'>())</span> <span class='p'>{</span>
	<span class='n'>result</span> <span class='o'>=</span> <span class='n'>rb_ary_new2</span><span class='p'>(</span><span class='n'>len</span><span class='p'>);</span>
    <span class='p'>}</span>

    <span class='k'>for</span> <span class='p'>(</span><span class='n'>i</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='n'>i</span><span class='o'>&lt;</span><span class='n'>RARRAY_LEN</span><span class='p'>(</span><span class='n'>ary</span><span class='p'>);</span> <span class='n'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
	<span class='n'>VALUE</span> <span class='n'>tmp</span> <span class='o'>=</span> <span class='n'>rb_ary_new2</span><span class='p'>(</span><span class='n'>argc</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>);</span>

	<span class='n'>rb_ary_push</span><span class='p'>(</span><span class='n'>tmp</span><span class='p'>,</span> <span class='n'>rb_ary_elt</span><span class='p'>(</span><span class='n'>ary</span><span class='p'>,</span> <span class='n'>i</span><span class='p'>));</span>
	<span class='k'>for</span> <span class='p'>(</span><span class='n'>j</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='n'>j</span><span class='o'>&lt;</span><span class='n'>argc</span><span class='p'>;</span> <span class='n'>j</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
	    <span class='n'>rb_ary_push</span><span class='p'>(</span><span class='n'>tmp</span><span class='p'>,</span> <span class='n'>rb_ary_elt</span><span class='p'>(</span><span class='n'>argv</span><span class='p'>[</span><span class='n'>j</span><span class='p'>],</span> <span class='n'>i</span><span class='p'>));</span>
	<span class='p'>}</span>
	<span class='k'>if</span> <span class='p'>(</span><span class='n'>NIL_P</span><span class='p'>(</span><span class='n'>result</span><span class='p'>))</span> <span class='p'>{</span>
	    <span class='n'>rb_yield</span><span class='p'>(</span><span class='n'>tmp</span><span class='p'>);</span>
	<span class='p'>}</span>
	<span class='k'>else</span> <span class='p'>{</span>
	    <span class='n'>rb_ary_push</span><span class='p'>(</span><span class='n'>result</span><span class='p'>,</span> <span class='n'>tmp</span><span class='p'>);</span>
	<span class='p'>}</span>
    <span class='p'>}</span>
    <span class='k'>return</span> <span class='n'>result</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p><em>Rubinius</em></p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>zip</span><span class='p'>(</span><span class='o'>*</span><span class='n'>others</span><span class='p'>)</span>
  <span class='n'>out</span> <span class='o'>=</span> <span class='nb'>Array</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='n'>size</span><span class='p'>)</span> <span class='p'>{</span> <span class='o'>[]</span> <span class='p'>}</span>
  <span class='n'>others</span> <span class='o'>=</span> <span class='n'>others</span><span class='o'>.</span><span class='n'>map</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>ary</span><span class='o'>|</span> <span class='n'>ary</span><span class='o'>.</span><span class='n'>to_ary</span> <span class='p'>}</span>

  <span class='n'>size</span><span class='o'>.</span><span class='n'>times</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>i</span><span class='o'>|</span>
    <span class='n'>slot</span> <span class='o'>=</span> <span class='n'>out</span><span class='o'>.</span><span class='n'>at</span><span class='p'>(</span><span class='n'>i</span><span class='p'>)</span>
    <span class='n'>slot</span> <span class='o'>&lt;&lt;</span> <span class='vi'>@tuple</span><span class='o'>.</span><span class='n'>at</span><span class='p'>(</span><span class='vi'>@start</span> <span class='o'>+</span> <span class='n'>i</span><span class='p'>)</span>
    <span class='n'>others</span><span class='o'>.</span><span class='n'>each</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>ary</span><span class='o'>|</span> <span class='n'>slot</span> <span class='o'>&lt;&lt;</span> <span class='n'>ary</span><span class='o'>.</span><span class='n'>at</span><span class='p'>(</span><span class='n'>i</span><span class='p'>)</span> <span class='p'>}</span>
  <span class='k'>end</span>

  <span class='k'>if</span> <span class='nb'>block_given?</span>
    <span class='n'>out</span><span class='o'>.</span><span class='n'>each</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>ary</span><span class='o'>|</span> <span class='k'>yield</span> <span class='n'>ary</span> <span class='p'>}</span>
    <span class='k'>return</span> <span class='kp'>nil</span>
  <span class='k'>end</span>

  <span class='n'>out</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>The zip method is somewhat obscure, I haven&#8217;t seen it used very often. Still, it is good to look overview what options ruby provides.</p>
      <a class="home" href="/">Home</a>
    </div>

    <div id= 'footer'>
      <a href="mailto:lake@lakedenman.com">Email</a> | 
      <a href="skype:call?name=lakedenman">Skype</a> | 
      <a href="http://twitter.com/ldenman">Twitter</a> |
      <a href="http://github.com/ldenman">Github</a>
    </div>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-350849-5");
      pageTracker._trackPageview();
      } catch(err) {}
      </script>
    </div>
  </body>
</html>